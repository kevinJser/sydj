var dataList =
    [
        {
            "areacode": "42032119940523898X",
            "name": "失业登记1",
            "id": "1",
            "data": {
                "aca112": "石油工程技术人员",
                "aac002": "330483199401081631",
                // "aac003": "朱凯枫",
                "bdc049": "",
                "aac009": "外地农业户口（外地农村）",
                // "bdc021": "就业人员",
                // "bdc041": "居住地失业登记",
                "province1": "浙江省",
                "city1": "嘉兴市",
                "area1": "嘉兴市桐乡市",
                "street1": "凤鸣街道",
                "community1": "长凤斗",
                "aac010": "浙江省嘉兴市桐乡市凤鸣街道长凤斗xx号",
                "area2": "西湖区",
                "street2": "西溪街道",
                "community2": "绝地岛",
                "aac026": "浙江省杭州市西湖区西溪街道绝地岛",
                "aac005": "汉族",
                "aac017": "未婚",
                "aac011": "大学本科",
                "aac181": "2016-7-1",
                "aac180": "邵阳学院",
                "aac183": "军事学",
                "aac067": "13586459509",
                "aae005": "",
                "ajc093": "用人单位失业",
                "ajc090": "2018-4-19",
                "bdc062": "是",
                "bdc067": "否",
                // "aae053": "33029323*******",
                "aab003": "91330108697051018N",
                // "aab0191": "私企",
                // "aab020": "私营经济",
                "aab004": "杭州设维信息技术有限公司",
                "bdc068": "自己领取",
                "bdc027": "xx社区xx栋xx楼xx号",
                "bdc042": "专业技术人员",
                "aac048": "不限",
                "acc034": 1000,
                "ccc204": "不限",
                "ccc266": "三班制,常日班",
                "aab019": "社会团体",
                "acc214": "无",
                "aae043": "2018-4-19",
                "bbc002": 1,
                "acb448": "否",
                "aae013": "无"

            }
        },
        {
            "areacode": "330103",
            "name": "失业登记2",
            "id": "09",
            "data": {
                "aca112": "矿山工程技术人员",
                "aac002": "330483199401081631",
                // "aac003": "朱凯枫",
                "bdc049": "",
                "aac009": "外地农业户口（外地农村）",
                // "bdc021": "就业人员",
                // "bdc041": "居住地失业登记",
                "province1": "浙江省",
                "city1": "嘉兴市",
                "area1": "嘉兴市桐乡市",
                "street1": "凤鸣街道",
                "community1": "长凤斗",
                "aac010": "浙江省嘉兴市桐乡市凤鸣街道长凤斗xx号",
                "area2": "西湖区",
                "street2": "西溪街道",
                "community2": "绝地岛",
                "aac026": "浙江省杭州市西湖区西溪街道绝地岛",
                "aac005": "汉族",
                "aac017": "未婚",
                "aac011": "大学本科",
                "aac181": "2016-7-1",
                "aac180": "邵阳学院1",
                "aac183": "军事学",
                "aac067": "13586459509",
                "aae005": "",
                "ajc093": "用人单位失业",
                "ajc090": "2018-4-19",
                "bdc062": "是",
                "bdc067": "否",
                // "aae053": "33029323*******",
                "aab003": "91330108697051018N",
                // "aab0191": "私企",
                // "aab020": "私营经济",
                "aab004": "杭州设维信息技术有限公司",
                "bdc068": "自己领取",
                "bdc027": "xx社区xx栋xx楼xx号",
                "bdc042": "专业技术人员",
                "aac048": "不限",
                "acc034": 1000,
                "ccc204": "不限",
                "ccc266": "三班制,常日班",
                "aab019": "社会团体",
                "acc214": "无",
                "aae043": "2018-4-19",
                "bbc002": 1,
                "acb448": "否",
                "aae013": "无"

            }
        },
        {
            "areacode": "330103",
            "name": "失业登记3",
            "id": "999",
            "data": {
                "aca112": "水利工程技术人员",
                "aac002": "330483199401081631",
                // "aac003": "朱凯枫",
                "bdc049": "",
                "aac009": "外地农业户口（外地农村）",
                // "bdc021": "就业人员",
                // "bdc041": "居住地失业登记",
                "province1": "浙江省",
                "city1": "嘉兴市",
                "area1": "嘉兴市桐乡市",
                "street1": "凤鸣街道",
                "community1": "长凤斗",
                "aac010": "浙江省嘉兴市桐乡市凤鸣街道长凤斗xx号",
                "area2": "西湖区",
                "street2": "西溪街道",
                "community2": "绝地岛",
                "aac026": "浙江省杭州市西湖区西溪街道绝地岛",
                "aac005": "汉族",
                "aac017": "未婚",
                "aac011": "大学本科",
                "aac181": "2016-7-1",
                "aac180": "邵阳学院2",
                "aac183": "军事学",
                "aac067": "13586459509",
                "aae005": "",
                "ajc093": "用人单位失业",
                "ajc090": "2018-4-19",
                "bdc062": "是",
                "bdc067": "否",
                // "aae053": "33029323*******",
                "aab003": "91330108697051018N",
                // "aab0191": "私企",
                // "aab020": "私营经济",
                "aab004": "杭州设维信息技术有限公司",
                "bdc068": "自己领取",
                "bdc027": "xx社区xx栋xx楼xx号",
                "bdc042": "专业技术人员",
                "aac048": "不限",
                "acc034": 1000,
                "ccc204": "不限",
                "ccc266": "三班制,常日班",
                "aab019": "社会团体",
                "acc214": "无",
                "aae043": "2018-4-19",
                "bbc002": 1,
                "acb448": "否",
                "aae013": "无"

            }
        },
    ];


dataList = [{ "id": "2c90892a62d2f17b0162d6426fa60016", "name": "失业登记", "areaCode": "330103005063", "data": { "aac002": "330681199002093318", "aac003": "周妙军", "bdc049": "3301581123", "aac009": "外地居民户口", "bdc021": "", "bdc041": "居住地失业登记", "province1": "浙江省", "city1": "杭州市", "area1": "下城区", "street1": "潮鸣街道", "community1": "艮山门社区", "areaCode1": "330103005063", "aac010": "", "area2": "", "street2": "", "community2": "", "aac026": "", "aac005": "汉族", "aac017": "未婚", "aac011": "职业高中", "aac181": "2012-04-24", "aac180": "职高", "aac183": "汽修", "aac067": "13888888888", "aae005": "88888888", "ajc093": "从用人单位失业", "ajc090": "2017-04-04", "bdc062": "否", "bdc067": "否", "aae053": "31231231823521312", "aab003": "GJ123131", "aab019": "企业", "aab020": "", "aab004": "", "bdc068": "自己领回", "bdc027": "", "bdc042": "单位负责人", "aca112": "其他", "aca216": "", "aac048": "", "acc034": "1000", "ccc204": "不限", "ccc266": "", "acc214": "五险一金", "aae043": "2018-04-03", "bcc002": "等待推荐", "acb448": "否", "username": "", "aae044": "", "orgname": "", "aae013": "" } }]

var EVENTLISTDATA;


/**
* 获取数据
*/
function httpRequest(callback) {
    openLoading();
    var url = "http://172.16.9.170/xcq/CertificateApiAction.pluginLineList.act?typeName=%E5%A4%B1%E4%B8%9A%E7%99%BB%E8%AE%B0";
    $.ajax({
        type: "GET",
        url: url,
        success: function (data) {
            closeLoading();
            console.log(JSON.parse(data));
            var data = JSON.parse(data);
            localStorage.setItem('feventListData', JSON.stringify(data));  //设置数据到localStorage
            callback(data, "暂无失业登记数据");
        },
        error: function (err) {
            console.log(err);
            alert('数据获取错误，请重启浏览器或联系管理员');
            window.close();
        }
    })
};

/* 文件下载 */
function fileRequest(id) {
    openLoading();
    var url = "http://172.16.9.170/xcq/CertificateApiAction.pluginAccessoryList.act?busId="
    var id = id;
    url = url + id;
    $.ajax({
        type: "GET",
        url: url,
        id: id,
        success: function (data) {
            closeLoading();
            console.log(data);
            var data = JSON.parse(data);
            console.log(data);
            var urls = 'http://127.0.0.1:9000/upload?urls=';
            var path = '';
            for (var i = 0; i < data.length; i++) {
                console.log(data[i].path);
                if (i === data.length - 1) {
                    path = data[i].path;
                } else {
                    path = data[i].path + ',';
                }
                urls += path;
            }
            urls = urls.replace(/(^\s+)|(\s+$)/g, "");
            console.log(urls);
            $.ajax({
                type: "GET",
                // url: 'http://127.0.0.1:9000/upload?urls=http://img.ui.cn/data/file/4/8/0/1811084.png,http://img.ui.cn/data/file/5/8/0/1811085.png,http://img.ui.cn/data/file/8/8/0/1811088.png',
                url: urls,
                success: function () {
                    console.log("success");
                    closeLoading();
                },
                error: function () {
                    closeLoading();
                    console.log("error");
                }
            })
        },
        error: function (err) {
            console.log(err);
            alert('数据获取错误，请重启浏览器或联系管理员')
        }
    })
}

/* 用户名登录 */
function loginRequest(name, pwd) {
    openLoading();
    var url = "http://172.16.9.170/xcq/CertificateApiAction.pluginLogin.act";
    $.ajax({
        type: "GET",
        data: {
            "userName": name,
            "password": pwd
        },
        url: url,
        success: function (data) {
            closeLoading();
            var data = data.replace(/(^\s*)|(\s*$)/g, "");
            if (data == "用户名或密码错误") {
                $(".loginin-err").addClass("active");
                return;
            }
            data = JSON.parse(data);
            var uid = data.uid;
            var name = data.name; //易加街道
            var areaCode = data.areaCode;
            var areaName = data.areaName;
            $(".loginin-err").removeClass("active");
            localStorage.setItem('sydjUid', uid);  //设置数据到localStorage 
            localStorage.removeItem('feventId');
            localStorage.removeItem('feventListData');
            $(".data-list").addClass("login");            
            $('.data-list').find('ul').html('请获取数据');
        },
        error: function (err) {
            console.log(err);
            alert('服务器错误，请重启浏览器或联系管理员')
        }
    })
}

/**
 * 获取本地列表数据
  */
function getLocalData(callback) {
    var localData = JSON.parse(localStorage.getItem('feventListData'));
    console.log("本地数据获取");
    if (localData !== null) {
        callback(localData, "请获取数据")
    } else {
        $('.data-list').find('ul').html("请获取数据");
    }

}

/* 获取本地用户uid ,切换对应的界面*/
function getUserId() {
    var userId = localStorage.getItem('sydjUid');
    if (userId !== null && userId !== "") {
        $(".data-list").addClass("login");
        //获取本地列表数据
        getLocalData(setData);
    } else {
        $(".data-list").removeClass("login");        
    }
}


/**
 * 数据展现为列表 
 */
function setData(data, noMsg) {
    EVENTLISTDATA = data;
    var eventLen = data.length;
    var eventName;
    var eventId;
    var liHtml = "";
    var completeId = localStorage.getItem('feventId'); //获取已经填充完成的事件id(1,99,990)  
    if (eventLen >= 1) {
        for (var i = 0; i < eventLen; i++) {
            eventName = data[i].name;
            eventId = data[i].id;
            if (completeId !== null) {
                if (completeId.indexOf(eventId) > -1) {
                    liHtml += '<li class="complete" data-id=' + eventId + ' data-arrayid=' + i + '>' +
                        '<span class="shadow"></span>' +
                        '<span class="event-title">' + eventName + '</span>' +
                        '<span class="fill">填充</span>' +
                        '<span class="finish">完成</span>' +
                        '</li>'
                } else {
                    liHtml += '<li data-id=' + eventId + ' data-arrayid=' + i + '>' +
                        '<span class="shadow"></span>' +
                        '<span class="event-title">' + eventName + '</span>' +
                        '<span class="fill">填充</span>' +
                        '<span class="finish">完成</span>' +
                        '</li>'
                }
            } else {
                liHtml += '<li data-id=' + eventId + ' data-arrayid=' + i + '>' +
                    '<span class="shadow"></span>' +
                    '<span class="event-title">' + eventName + '</span>' +
                    '<span class="fill">填充</span>' +
                    '<span class="finish">完成</span>' +
                    '</li>'
            }
        };
        $('.data-list').find('ul').html(liHtml);
    } else {
        $('.data-list').find('ul').html(noMsg);
    }
};

/**
 * loading打开
  */
function openLoading() {
    $('.load-container').addClass('active');
}
/**
 * loading关闭
  */
function closeLoading() {
    $('.load-container').removeClass('active');
}

$(function () {

    //获取用户信息
    getUserId();

    //点击获取数据
    $('.get-data').on('click', function () {
        //清除对应的locastorage
        localStorage.removeItem('feventId');
        localStorage.removeItem('feventListData');

        function getData() {
            var hasItemId = localStorage.getItem('feventId');
            var hasItemData = localStorage.getItem('feventListData');
            if (hasItemId == null && hasItemData == null) {
                httpRequest(setData);
            } else {
                setTimeout(getData, 1000);
            }
        };
        getData();
    });

    //点击登录
    $(".loginin-btn").on('click', function () {
        var username = $('#userName').val();
        var password = $('#password').val();
        if (username === "" || password === "") {
            $('.loginin-err').addClass("active");
            return;
        }
        loginRequest(username, password);
    })
    //enter
    $(document).keyup(function (event) {
        if (event.keyCode == 13) {
            var username = $('#userName').val();
            var password = $('#password').val();
            if (username === "" || password === "") {
                $('.loginin-err').addClass("active");
                return;
            }
            loginRequest(username, password);
        }
    });

    //填充点击
    $('.data-list').on('click', '.fill', function () {
        var eventId = $(this).parent('li').attr('data-id');
        var index = $(this).parent('li').attr('data-arrayid');
        var eventData = EVENTLISTDATA[index].data;
        var obj = {
            msg: '从 popup 弹窗页面  向 Content Script 传递消息',
            id: eventId,
            data: eventData,
            result: 0
        };
        fileRequest(eventId);
        // 发送消息
        chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
            chrome.tabs.sendMessage(tabs[0].id, obj, function (response) {
                console.log("Send Success");
                // window.close();
            });
        });
    });

    //完成点击
    $('.data-list').on('click', '.finish', function () {
        var r = confirm("请确认该条数据已经保存完成!");
        if (r == true) {
            var eventId = $(this).parent('li').attr('data-id');
            var index = $(this).parent('li').attr('data-arrayid');
            $(this).parent('li').addClass('complete');
            //数据存贮到localstorage        
            if (localStorage.getItem('feventId') !== null) {
                console.log('有');
                var completeId = localStorage.getItem('feventId');
                completeId += "," + eventId;
                localStorage.setItem('feventId', completeId);
            } else {
                console.log("没有");
                localStorage.setItem('feventId', eventId); //设置该数据已经填充完成  
            };



            //把事件id传给后台  


        };
    })

    //退出账号
    $('.loginout').on('click', function () {
        localStorage.removeItem('sydjUid');
        $('.data-list').removeClass('login');
    })

    //input改变
    $('input').on('input', function () {
        $('.loginin-err').removeClass('active');
    })

});

